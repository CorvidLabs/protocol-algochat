name: Implementation Status

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  test-swift:
    runs-on: macos-latest
    steps:
      - name: Checkout swift-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/swift-algochat

      - name: Run Swift tests
        run: |
          set +e
          START_TIME=$(date +%s)
          # Use --verbose to get detailed output including test count summary
          swift test --verbose 2>&1 | tee swift_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          END_TIME=$(date +%s)
          DURATION=$(( (END_TIME - START_TIME) * 1000 ))

          echo "=== Swift test output tail ==="
          tail -30 swift_output.txt

          PASSED=0
          FAILED=0

          # Try Swift Testing format: "Test run with 55 tests passed"
          if SUMMARY_LINE=$(grep -E "Test run with [0-9]+ test" swift_output.txt); then
            echo "Found summary: $SUMMARY_LINE"
            PASSED=$(echo "$SUMMARY_LINE" | grep -oE '[0-9]+ test' | grep -oE '[0-9]+' | head -1)
            if echo "$SUMMARY_LINE" | grep -q "failed"; then
              FAILED=$(echo "$SUMMARY_LINE" | grep -oE '[0-9]+ failed' | grep -oE '[0-9]+' | head -1)
            fi
          # Fallback: XCTest format "Executed X tests"
          elif EXECUTED_LINE=$(grep -E "Executed [0-9]+ test" swift_output.txt | tail -1); then
            echo "Found executed: $EXECUTED_LINE"
            PASSED=$(echo "$EXECUTED_LINE" | grep -oE 'Executed [0-9]+' | grep -oE '[0-9]+')
            FAILED=$(echo "$EXECUTED_LINE" | grep -oE '[0-9]+ failure' | grep -oE '[0-9]+' | head -1)
          # Fallback: Count individual test passed markers
          else
            echo "Using fallback: counting individual markers"
            PASSED=$(grep -c "✔\|passed at\|Test passed" swift_output.txt 2>/dev/null || echo "0")
            FAILED=$(grep -c "✘\|failed at\|Test failed" swift_output.txt 2>/dev/null || echo "0")
          fi

          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > swift-algochat.json << EOF
          {
            "implementationId": "swift-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          cat swift-algochat.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: swift-algochat-result
          path: swift-algochat.json

  test-typescript:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ts-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/ts-algochat

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run TypeScript tests
        run: |
          set +e
          START_TIME=$(date +%s)
          OUTPUT=$(bun test 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$(( (END_TIME - START_TIME) * 1000 ))

          echo "$OUTPUT"

          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= pass)' | head -1)
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= fail)' | head -1)
          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > ts-algochat.json << EOF
          {
            "implementationId": "ts-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          cat ts-algochat.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: ts-algochat-result
          path: ts-algochat.json

  test-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout py-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/py-algochat

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]" || pip install -e .
          pip install pytest

      - name: Run Python tests
        run: |
          set +e
          START_TIME=$(date +%s)
          OUTPUT=$(pytest -v 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$(( (END_TIME - START_TIME) * 1000 ))

          echo "$OUTPUT"

          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= passed)' | head -1)
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= failed)' | head -1)
          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > py-algochat.json << EOF
          {
            "implementationId": "py-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          cat py-algochat.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: py-algochat-result
          path: py-algochat.json

  test-rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout rs-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/rs-algochat

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run Rust tests
        run: |
          set +e
          START_TIME=$(date +%s)
          OUTPUT=$(cargo test 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$(( (END_TIME - START_TIME) * 1000 ))

          echo "$OUTPUT"

          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= passed)' | head -1)
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= failed)' | head -1)
          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > rs-algochat.json << EOF
          {
            "implementationId": "rs-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          cat rs-algochat.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: rs-algochat-result
          path: rs-algochat.json

  test-kotlin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout kt-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/kt-algochat

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Kotlin tests
        run: |
          set +e
          START_TIME=$(date +%s)
          OUTPUT=$(./gradlew test --console=plain 2>&1 || gradle test --console=plain 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$(( (END_TIME - START_TIME) * 1000 ))

          echo "$OUTPUT"

          # Gradle output: "X tests completed, Y failed"
          TOTAL=$(echo "$OUTPUT" | grep -oP '\d+(?= tests? completed)' | head -1)
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= failed)' | head -1)
          [ -z "$TOTAL" ] && TOTAL=0
          [ -z "$FAILED" ] && FAILED=0
          PASSED=$((TOTAL - FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > kt-algochat.json << EOF
          {
            "implementationId": "kt-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          cat kt-algochat.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: kt-algochat-result
          path: kt-algochat.json

  test-web:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout algochat-web
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/algochat-web

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run tests
        run: |
          set +e
          START_TIME=$(date +%s)

          # Check if tests exist
          if [ -d "tests" ] || [ -d "test" ] || ls *.test.ts >/dev/null 2>&1 || ls **/*.test.ts >/dev/null 2>&1; then
            OUTPUT=$(bun test 2>&1)
            EXIT_CODE=$?
          else
            OUTPUT="No tests found"
            EXIT_CODE=0
          fi

          END_TIME=$(date +%s)
          DURATION=$(( (END_TIME - START_TIME) * 1000 ))

          echo "$OUTPUT"

          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= pass)' | head -1)
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= fail)' | head -1)
          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          # No tests is not an error for early-stage projects
          if [ "$OUTPUT" = "No tests found" ]; then
            ERROR="null"
          elif [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > algochat-web.json << EOF
          {
            "implementationId": "algochat-web",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          cat algochat-web.json

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: algochat-web-result
          path: algochat-web.json

  generate-status:
    needs: [test-swift, test-typescript, test-python, test-rust, test-kotlin, test-web]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout protocol repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize results
        run: |
          mkdir -p test-results badges
          for dir in artifacts/*-result; do
            if [ -d "$dir" ]; then
              for f in "$dir"/*.json; do
                cp "$f" test-results/
              done
            fi
          done
          echo "=== Test Results ==="
          cat test-results/*.json

      - name: Generate status page
        run: bun scripts/generate-status.ts

      - name: Upload status artifacts
        uses: actions/upload-artifact@v4
        with:
          name: status-page
          path: |
            status.html
            badges/

  deploy:
    needs: generate-status
    if: always() && needs.generate-status.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download status page
        uses: actions/download-artifact@v4
        with:
          name: status-page
          path: ./

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
