name: Implementation Status

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  test-swift:
    runs-on: macos-latest
    steps:
      - name: Checkout test-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/test-algochat
          submodules: recursive

      - name: Run Swift tests
        id: test
        run: |
          set +e
          START_TIME=$(date +%s%3N)
          OUTPUT=$(swift run TestAlgoChat crypto 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))

          PASSED=$(echo "$OUTPUT" | grep -c "✓\|PASS")
          FAILED=$(echo "$OUTPUT" | grep -c "✗\|FAIL")
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > swift-algochat.json << EOF
          {
            "implementationId": "swift-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: swift-algochat-result
          path: swift-algochat.json

  test-typescript:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/test-algochat
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Run TypeScript tests
        id: test
        run: |
          set +e
          START_TIME=$(date +%s%3N)
          OUTPUT=$(bun test ts/crypto.test.ts 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))

          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= pass)' | head -1 || echo "0")
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= fail)' | head -1 || echo "0")
          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > ts-algochat.json << EOF
          {
            "implementationId": "ts-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: ts-algochat-result
          path: ts-algochat.json

  test-python:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/test-algochat
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd py-algochat
          pip install -e ".[dev]" || pip install -e .
          pip install pytest

      - name: Run Python tests
        id: test
        run: |
          set +e
          cd py-algochat
          START_TIME=$(date +%s%3N)
          OUTPUT=$(pytest -v 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))

          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= passed)' | head -1 || echo "0")
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= failed)' | head -1 || echo "0")
          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > ../py-algochat.json << EOF
          {
            "implementationId": "py-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: py-algochat-result
          path: py-algochat.json

  test-rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/test-algochat
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run Rust tests
        id: test
        run: |
          set +e
          cd rs-algochat
          START_TIME=$(date +%s%3N)
          OUTPUT=$(cargo test 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))

          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= passed)' | head -1 || echo "0")
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= failed)' | head -1 || echo "0")
          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > ../rs-algochat.json << EOF
          {
            "implementationId": "rs-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: rs-algochat-result
          path: rs-algochat.json

  test-kotlin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test-algochat
        uses: actions/checkout@v4
        with:
          repository: CorvidLabs/test-algochat
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Kotlin tests
        id: test
        run: |
          set +e
          cd kt-algochat
          START_TIME=$(date +%s%3N)
          OUTPUT=$(./gradlew test 2>&1 || gradle test 2>&1)
          EXIT_CODE=$?
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))

          PASSED=$(echo "$OUTPUT" | grep -oP '\d+(?= passed)' | head -1 || echo "0")
          FAILED=$(echo "$OUTPUT" | grep -oP '\d+(?= failed)' | head -1 || echo "0")
          [ -z "$PASSED" ] && PASSED=0
          [ -z "$FAILED" ] && FAILED=0
          TOTAL=$((PASSED + FAILED))

          if [ $EXIT_CODE -ne 0 ] && [ $TOTAL -eq 0 ]; then
            ERROR="\"Build failed\""
          else
            ERROR="null"
          fi

          cat > ../kt-algochat.json << EOF
          {
            "implementationId": "kt-algochat",
            "passed": $PASSED,
            "failed": $FAILED,
            "skipped": 0,
            "total": $TOTAL,
            "duration": $DURATION,
            "error": $ERROR,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: kt-algochat-result
          path: kt-algochat.json

  placeholder-platform:
    runs-on: ubuntu-latest
    steps:
      - name: Create placeholder
        run: |
          cat > algochat-platform.json << EOF
          {
            "implementationId": "algochat-platform",
            "passed": 0,
            "failed": 0,
            "skipped": 0,
            "total": 0,
            "duration": 0,
            "error": null,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: algochat-platform-result
          path: algochat-platform.json

  generate-status:
    needs: [test-swift, test-typescript, test-python, test-rust, test-kotlin, placeholder-platform]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout protocol repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize results
        run: |
          mkdir -p test-results badges
          for dir in artifacts/*-result; do
            if [ -d "$dir" ]; then
              for f in "$dir"/*.json; do
                cp "$f" test-results/
              done
            fi
          done
          ls -la test-results/

      - name: Generate status page
        run: bun scripts/generate-status.ts

      - name: Upload status artifacts
        uses: actions/upload-artifact@v4
        with:
          name: status-page
          path: |
            status.html
            badges/

  deploy:
    needs: generate-status
    if: always() && needs.generate-status.result == 'success'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download status page
        uses: actions/download-artifact@v4
        with:
          name: status-page
          path: ./

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
